<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrati - Pianificatore Sessioni D&D</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dnd-black': '#0a0a0a',
                        'dnd-dark': '#1a1a1a',
                        'dnd-darker': '#121212',
                        'dnd-red': '#dc2626',
                        'dnd-red-dark': '#991b1b',
                        'dnd-red-light': '#ef4444',
                        'dnd-crimson': '#8b0000',
                        'dnd-gold': '#fbbf24',
                        // Legacy mappings
                        'forest': '#dc2626',
                        'amber': '#fbbf24',
                        'mystic': '#8b0000',
                        'cream': '#f5f5f5',
                        'emerald': '#dc2626',
                        'deep-red': '#991b1b'
                    },
                    fontFamily: {
                        'cinzel': ['Cinzel', 'serif'],
                        'inter': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- D&D Theme CSS -->
    <link rel="stylesheet" href="css/dnd-theme.css">

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body class="font-inter">
    <div class="min-h-screen flex items-center justify-center px-4 py-12">
        <div class="max-w-md w-full">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div
                    class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-forest to-mystic rounded-xl mb-4">
                    <span class="text-white font-cinzel font-bold text-2xl">D&D</span>
                </div>
                <h1 class="font-cinzel text-3xl font-bold text-forest">Crea Account</h1>
                <p class="text-gray-600 mt-2">Unisciti all'avventura!</p>
            </div>

            <!-- Registration Form -->
            <div class="bg-white rounded-2xl shadow-xl mystical-glow p-8">
                <form id="register-form" class="space-y-6">
                    <!-- Name -->
                    <div>
                        <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">
                            Nome Completo
                        </label>
                        <input type="text" id="name" name="name" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber focus:border-transparent transition-all"
                            placeholder="Inserisci il tuo nome">
                    </div>

                    <!-- Email -->
                    <div>
                        <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                            Indirizzo Email
                        </label>
                        <input type="email" id="email" name="email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber focus:border-transparent transition-all"
                            placeholder="tuo@email.com">
                    </div>

                    <!-- Password -->
                    <div>
                        <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">
                            Password
                        </label>
                        <input type="password" id="password" name="password" required minlength="8"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber focus:border-transparent transition-all"
                            placeholder="Almeno 8 caratteri">

                        <!-- Password Strength Meter -->
                        <div class="mt-2 transition-all duration-300" id="strength-container" style="opacity: 0;">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-semibold text-gray-500" id="strength-text">Debole</span>
                                <span class="text-xs text-gray-400" id="strength-feedback"></span>
                            </div>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div id="strength-bar"
                                    class="h-full w-0 transition-all duration-500 ease-out bg-red-500"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Confirm Password -->
                    <div>
                        <label for="confirm-password" class="block text-sm font-semibold text-gray-700 mb-2">
                            Conferma Password
                        </label>
                        <input type="password" id="confirm-password" name="confirm-password" required minlength="8"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber focus:border-transparent transition-all"
                            placeholder="Reinserisci la password">
                    </div>

                    <!-- Error Message -->
                    <div id="error-message"
                        class="hidden bg-deep-red/10 border border-deep-red text-deep-red px-4 py-3 rounded-lg text-sm">
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submit-btn"
                        class="w-full bg-forest text-white py-3 rounded-lg font-semibold mystical-glow hover:bg-forest/90 transition-all">
                        Crea Account
                    </button>
                </form>

                <!-- Google Sign-In -->
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">Oppure</span>
                    </div>
                </div>

                <div class="flex justify-center" id="google-login-container" style="min-height: 40px;">
                    <!-- Google Button rendered here -->
                    <span class="text-gray-400 text-sm">Caricamento Google Login...</span>
                </div>

                <!-- Login Link -->
                <div class="mt-6 text-center">
                    <p class="text-gray-600">
                        Hai già un account?
                        <a href="/login.html" class="text-forest font-semibold hover:text-amber transition-colors">
                            Accedi
                        </a>
                    </p>
                </div>
            </div>

            <!-- Back to Home -->
            <div class="mt-6 text-center">
                <a href="/index.html" class="text-gray-600 hover:text-forest transition-colors">
                    ← Torna alla Home
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js"></script>
    <script src="js/auth-utils.js?v=2"></script>
    <!-- script src="js/auth.js"></script -->
    <script>
        // Initialize Google Login
        document.addEventListener('DOMContentLoaded', () => {
            if (window.authManager) {
                window.authManager.initGoogleLogin('google-login-container');
            }
        });

        // Password Strength Meter Logic
        const passwordInput = document.getElementById('password');
        const strengthContainer = document.getElementById('strength-container');
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        const strengthFeedback = document.getElementById('strength-feedback');

        passwordInput.addEventListener('input', function () {
            const val = this.value;
            if (val.length > 0) {
                strengthContainer.style.opacity = '1';
                const result = zxcvbn(val);
                const score = result.score; // 0-4

                // Colors and texts
                const colors = ['bg-dnd-red', 'bg-red-400', 'bg-yellow-500', 'bg-blue-400', 'bg-green-500'];
                const texts = ['Molto Debole', 'Debole', 'Discreta', 'Buona', 'Forte'];
                const widths = ['20%', '40%', '60%', '80%', '100%'];

                // Update UI
                strengthBar.className = `h-full transition-all duration-300 ease-out ${colors[score]}`;
                strengthBar.style.width = widths[score];
                strengthText.textContent = texts[score];

                // Show warning if any, else generic feedback
                if (result.feedback.warning) {
                    // Simple translation map for common zxcvbn warnings
                    const warningMap = {
                        "Straight rows of keys are easy to guess": "Le file di tasti sono facili da indovinare",
                        "Short keyboard patterns are easy to guess": "Pattern brevi da tastiera sono facili da indovinare",
                        "Repeats like \"aaa\" are easy to guess": "Ripetizioni come \"aaa\" sono facili da indovinare",
                    };
                    strengthFeedback.textContent = warningMap[result.feedback.warning] || result.feedback.warning;
                    strengthFeedback.className = "text-xs text-red-400 text-right";
                } else {
                    strengthFeedback.textContent = "";
                }

            } else {
                strengthContainer.style.opacity = '0';
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('error-message');
            const submitBtn = document.getElementById('submit-btn');

            // Clear previous errors
            errorDiv.classList.add('hidden');

            // Validate passwords match
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Le password non corrispondono';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Disable button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creazione account...';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Registrazione fallita');
                }

                // Store auth token
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('currentUser', JSON.stringify(data.user));

                // Redirect to dashboard
                window.location.href = '/index.html';

            } catch (error) {
                console.error('Registration error:', error);
                errorDiv.textContent = error.message || 'Impossibile creare l\'account. Riprova.';
                errorDiv.classList.remove('hidden');

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Crea Account';
            }
        });
    </script>
</body>

</html>