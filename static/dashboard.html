<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Mia Bacheca - Pianificatore Sessioni D&D</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dnd-black': '#0a0a0a',
                        'dnd-dark': '#1a1a1a',
                        'dnd-darker': '#121212',
                        'dnd-red': '#dc2626',
                        'dnd-red-dark': '#991b1b',
                        'dnd-red-light': '#ef4444',
                        'dnd-crimson': '#8b0000',
                        'dnd-gold': '#fbbf24',
                        // Legacy mappings
                        'forest': '#dc2626',
                        'amber': '#fbbf24',
                        'mystic': '#8b0000',
                        'cream': '#f5f5f5',
                        'emerald': '#dc2626',
                        'deep-red': '#991b1b'
                    },
                    fontFamily: {
                        'cinzel': ['Cinzel', 'serif'],
                        'inter': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- D&D Theme CSS -->
    <link rel="stylesheet" href="css/dnd-theme.css">
</head>

<body class="font-inter">
    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-sm border-b border-amber/20 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-forest to-mystic rounded-lg flex items-center justify-center">
                        <span class="text-white font-cinzel font-bold text-lg">D&D</span>
                    </div>
                    <h1 class="font-cinzel text-xl font-semibold text-forest">La Mia Bacheca</h1>
                </div>

                <div class="flex items-center space-x-3">
                    <a href="http://127.0.0.1:30000/auth" target="_blank" data-foundry-btn
                        class="flex items-center space-x-2 bg-gradient-to-r from-amber to-copper text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all">
                        <span>üé≤</span>
                        <span>FoundryVTT</span>
                    </a>
                    <div id="user-display" class="flex items-center space-x-2 text-forest font-medium"></div>
                    <button id="logout-btn"
                        class="flex items-center space-x-2 bg-gradient-to-r from-deep-red to-mystic text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all">
                        <span>üö™</span>
                        <span>Esci</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Welcome Section -->
        <div class="mb-8">
            <h2 class="font-cinzel text-3xl font-bold text-forest mb-2">Bentornato, <span
                    id="user-name">Avventuriero</span>!</h2>
            <p class="text-gray-600">Gestisci le tue sessioni D&D e la tua disponibilit√†</p>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg mystical-glow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Sessioni Totali</p>
                        <p class="text-3xl font-bold text-forest" id="total-sessions">0</p>
                    </div>
                    <div class="w-12 h-12 bg-forest/10 rounded-lg flex items-center justify-center">
                        <span class="text-2xl">üé≤</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mystical-glow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Disponibilit√† Inviate</p>
                        <p class="text-3xl font-bold text-emerald" id="submitted-count">0</p>
                    </div>
                    <div class="w-12 h-12 bg-emerald/10 rounded-lg flex items-center justify-center">
                        <span class="text-2xl">‚úÖ</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg mystical-glow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">In Attesa</p>
                        <p class="text-3xl font-bold text-amber" id="pending-count">0</p>
                    </div>
                    <div class="w-12 h-12 bg-amber/10 rounded-lg flex items-center justify-center">
                        <span class="text-2xl">‚è≥</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Sessions -->
        <div class="bg-white rounded-xl shadow-lg mystical-glow p-6 mb-8">
            <h3 class="font-cinzel text-2xl font-bold text-forest mb-6">Le Mie Sessioni</h3>

            <div id="sessions-list" class="space-y-4">
                <!-- Le sessioni saranno caricate qui -->
                <div class="text-center py-8 text-gray-500">
                    <p>Caricamento sessioni...</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="quick-actions-grid">
            <a href="/participate.html"
                class="bg-gradient-to-br from-forest to-emerald text-white rounded-xl shadow-lg mystical-glow p-6 text-center hover:scale-105 transition-transform">
                <div class="text-4xl mb-2">üéØ</div>
                <h4 class="font-cinzel text-xl font-bold mb-2">Partecipa</h4>
                <p class="text-white/80">Indica la tua disponibilit√† per le sessioni</p>
            </a>

            <a href="/profile.html"
                class="bg-gradient-to-br from-mystic to-amber text-white rounded-xl shadow-lg mystical-glow p-6 text-center hover:scale-105 transition-transform">
                <div class="text-4xl mb-2">‚öôÔ∏è</div>
                <h4 class="font-cinzel text-xl font-bold mb-2">Impostazioni Profilo</h4>
                <p class="text-white/80">Gestisci il tuo account e le preferenze</p>
            </a>

            <!-- DM Only Actions (Hidden by default) -->
            <a href="/create-poll.html" id="create-campaign-btn"
                class="hidden bg-gradient-to-br from-dnd-gold to-yellow-600 text-white rounded-xl shadow-lg mystical-glow p-6 text-center hover:scale-105 transition-transform">
                <div class="text-4xl mb-2">üìú</div>
                <h4 class="font-cinzel text-xl font-bold mb-2">Crea Nuova Campagna</h4>
                <p class="text-white/80">Organizza una nuova avventura</p>
            </a>
        </div>
    </div>

    <script src="js/nav-protection.js"></script>
    <script src="js/session-manager.js?v=5"></script>
    <script src="js/foundry-config.js"></script>


    <script src="js/auth-utils.js?v=3"></script>
    <script>
        // Initialize dashboard - require authentication first
        async function initDashboard() {
            console.log('üöÄ [DASHBOARD] Starting initialization...');
            console.log('üîç [DASHBOARD] Checking localStorage...');
            console.log('   Token:', localStorage.getItem('authToken') ? 'EXISTS (length: ' + localStorage.getItem('authToken').length + ')' : 'NOT FOUND');
            console.log('   User:', localStorage.getItem('currentUser') ? 'EXISTS' : 'NOT FOUND');

            if (!window.authManager) {
                console.error('‚ùå [DASHBOARD] authManager not found!');
                return;
            }

            console.log('‚úÖ [DASHBOARD] authManager found, calling requireAuth...');

            // Require authentication - AWAIT the result
            const isAuthenticated = await window.authManager.requireAuth('/dashboard.html');

            console.log('üìä [DASHBOARD] requireAuth returned:', isAuthenticated);

            if (!isAuthenticated) {
                console.log('‚ùå [DASHBOARD] Authentication failed, will redirect...');
                return; // Will be redirected by requireAuth
            }

            console.log('‚úÖ [DASHBOARD] User authenticated successfully!');
            console.log('üë§ [DASHBOARD] Current user:', window.authManager.user);

            // Update user name
            if (window.authManager.user) {
                document.getElementById('user-name').textContent = window.authManager.user.name;
                console.log('‚úÖ [DASHBOARD] User name updated in UI');

                // Check for DM role and show create button
                if (window.authManager.user.role === 'dm') {
                    console.log('üé≤ [DASHBOARD] User is DM, showing create campaign button');
                    const createBtn = document.getElementById('create-campaign-btn');
                    const actionsGrid = document.getElementById('quick-actions-grid');

                    if (createBtn) {
                        createBtn.classList.remove('hidden');
                        // Update grid layout to 3 columns if on larger screens
                        if (actionsGrid) {
                            actionsGrid.classList.remove('md:grid-cols-2');
                            actionsGrid.classList.add('md:grid-cols-3');
                        }
                    }
                }
            }

            // Load sessions
            console.log('üìã [DASHBOARD] Loading user sessions...');
            await loadUserSessions();
            console.log('‚úÖ [DASHBOARD] Dashboard fully loaded!');
        }

        // Load user's sessions
        async function loadUserSessions() {
            try {
                // Get all polls
                const response = await fetch('/api/polls');
                if (!response.ok) throw new Error(`Failed to fetch polls: ${response.status} ${response.statusText}`);
                const polls = await response.json();

                // Filter polls where user is a participant
                const userEmail = window.authManager.user.email;
                if (!userEmail) throw new Error("User email not found in profile");

                const userSessionsCtx = [];

                // Fetch details for all polls in parallel (with limit/robustness if needed)
                // Using Promise.allSettled to prevent one failure from breaking everything
                const pollPromises = polls.map(async (poll) => {
                    try {
                        const pollResponse = await fetch(`/api/polls/${poll.id}`);
                        if (!pollResponse.ok) return null; // Skip if failed
                        const pollData = await pollResponse.json();

                        // Check if user is a participant
                        // Check if user is a participant or organizer
                        // Handle potential missing participants array
                        const isParticipant = pollData && pollData.participants && pollData.participants.some(p => p.email === userEmail);
                        const isOrganizer = pollData && pollData.organizer_id === window.authManager.user.id;

                        if (isParticipant || isOrganizer) {
                            return pollData;
                        }
                    } catch (e) {
                        console.error(`Error processing poll ${poll.id}:`, e);
                        return null;
                    }
                    return null;
                });

                const results = await Promise.all(pollPromises);
                const userSessions = results.filter(p => p !== null);

                // Update stats
                document.getElementById('total-sessions').textContent = userSessions.length;

                // Count submitted vs pending
                let submitted = 0;
                let pending = 0;

                for (const session of userSessions) {
                    const participant = session.participants.find(p => p.email === userEmail);
                    if (participant && session.availability && session.availability.some(a => a.participant_id === participant.id)) {
                        submitted++;
                    } else {
                        pending++;
                    }
                }

                document.getElementById('submitted-count').textContent = submitted;
                document.getElementById('pending-count').textContent = pending;

                // Display sessions
                const sessionsList = document.getElementById('sessions-list');

                if (userSessions.length === 0) {
                    sessionsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p class="mb-4">Non hai ancora partecipato a nessuna sessione.</p>
                            <a href="/participate.html" class="text-forest font-semibold hover:text-amber transition-colors">
                                Partecipa alla tua prima sessione ‚Üí
                            </a>
                        </div>
                    `;
                } else {
                    sessionsList.innerHTML = userSessions.map(session => {
                        const participant = session.participants.find(p => p.email === userEmail);
                        const hasSubmitted = participant && session.availability && session.availability.some(a => a.participant_id === participant.id);

                        const isDM = window.authManager.user.role === 'dm';

                        return `
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-amber transition-colors">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-forest text-lg">${session.poll.title}</h4>
                                        <p class="text-gray-600 text-sm mt-1">${(session.poll.description || '').split('\n')[0]}</p>
                                        <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                            <span>üìç ${session.poll.location || 'Online'}</span>
                                            <span>üë• ${session.participants.length} partecipanti</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end space-y-2">
                                        ${hasSubmitted
                                ? '<span class="px-3 py-1 bg-emerald/10 text-emerald text-xs font-medium rounded-full">‚úÖ Inviato</span>'
                                : '<span class="px-3 py-1 bg-amber/10 text-amber text-xs font-medium rounded-full">‚è≥ In Attesa</span>'
                            }
                                        <div class="flex space-x-2">
                                            ${isDM ? `
                                            <a href="/manage.html?poll=${session.poll.id}&action=edit" class="text-amber hover:text-amber-700 transition-colors text-sm font-medium">
                                                ‚úèÔ∏è Modifica
                                            </a>` : ''}
                                            <a href="/participate.html?session=${session.poll.id}" class="text-forest hover:text-amber transition-colors text-sm font-medium">
                                                ${hasSubmitted ? 'Aggiorna' : 'Invia'} Disponibilit√† ‚Üí
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('sessions-list').innerHTML = `
                    <div class="text-center py-8 text-deep-red">
                        <p>Impossibile caricare le sessioni: ${error.message}</p>
                        <p class="text-sm mt-2 text-gray-500">Per favore riprova o contatta l'amministratore.</p>
                    </div>
                `;
            }
        }

        // Load sessions on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM loaded, starting authentication...');
            initDashboard();
        });
    </script>
</body>

</html>